{% from "common/partials/mhclg-header.html" import mhclgHeader %}
{% from "govuk_frontend_jinja/components/phase-banner/macro.html" import govukPhaseBanner %}
{% from "govuk_frontend_jinja/components/service-navigation/macro.html" import govukServiceNavigation %}
{% from "govuk_frontend_jinja/components/back-link/macro.html" import govukBackLink %}
{% from "govuk_frontend_jinja/components/footer/macro.html" import govukFooter %}


{% extends "govuk_frontend_jinja/template.html" %}
{% set assetPath = url_for('static', filename='').rstrip('/') %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='govuk-frontend-5.7.1.min.css') }}" />
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='main.css') }}" />
{% endblock head %}

{% if not config.SUPPRESS_PROTOTYPE_WATERMARK_SORRY_SAM %}
{% set bodyClasses = "watermark--prototype" %}
{% endif %}

{% block header %}
{# {{ mhclgHeader({
    "productName": "MHCLG Funding",
    "homepageUrl": url_for('proto_apply.grant_blueprint.all_open_grants_handler'),
    "classes": "govuk-header--full-width-border",
    "navigation": [{"html": "<span class='govuk-visually-hidden'>Logged in as </span>" ~ g.account.email, "href": "#"}, {"text": "Sign out", "href": url_for('proto_apply.web.magic_links_sign_out_handler')}],
    "navigationClasses": "govuk-header__navigation--end"
}) }} #}
{% include "manage/one_login_header.html" %}

{% set navigationItems = [
    {"href": url_for('proto_manage.platform.grants.index'), "text": "Grants", "active": active_navigation_tab == 'grants'},
    {"href": url_for('proto_manage.assess.route_grant_applications'), "text": "Applications", "active": active_navigation_tab == 'applications'},
    {"href": "#", "text": "Recipients", "active": active_navigation_tab == 'recipients'},
    {"href": "#", "text": "Payments", "active": active_navigation_tab == 'payments'},
    {"href": "#", "text": "Reports", "active": active_navigation_tab == 'reports'},
] %}
{% if g.account.is_platform_admin %}
  {% set __ = navigationItems.append({"href": url_for('admin.index'), "text": "Admin", "active": active_navigation_tab == 'admin'}) %}
{% endif %}
{{ govukServiceNavigation({
  "serviceName": "Grant management",
  "navigationClasses": "app-service-navigation--fill" if g.account.is_platform_admin else "",
  "navigation": navigationItems,
}) }}
{% endblock header %}

{% block beforeContent %}

{% set feedbackMessage %}
{% trans %}This is a new service. Help us improve it and{% endtrans %} <a href="#" class="govuk-link govuk-link--no-visited-state">{% trans %}give your feedback (opens in new tab).{% endtrans %}</a>
{% endset %}

{% if back_link %}
{{ govukBackLink({"href": back_link}) }}
{% endif %}
{% endblock beforeContent %}

{% block bodyEnd %}
    <script type="module" src="{{ url_for('static', filename='govuk-frontend-5.7.1.min.js') }}"> </script>
    <script type="module" nonce="{{ csp_nonce() }}">
        import { initAll } from "{{ url_for('static', filename='govuk-frontend-5.7.1.min.js') }}"
        initAll()
    </script>

    <script type="module" nonce="{{ csp_nonce() }}">
        // copied from https://github.com/govuk-one-login/service-header/blob/main/dist/scripts/service-header.js
        /**
        * A modified adaptation of the Design System header script
        */
        function CrossServiceHeader ($module) {
            this.$header = $module
            this.$navigation = $module && $module.querySelectorAll("[data-one-login-header-nav]")
            this.$numberOfNavs = this.$navigation && this.$navigation.length
            /**
            * Handle menu button click
            *
            * When the menu button is clicked, change the visibility of the menu and then
            * sync the accessibility state and menu button state
            */
            this.handleMenuButtonClick = function() {
                this.isOpen = !this.isOpen;
                this.$menuOpenClass && this.$menu.classList.toggle(this.$menuOpenClass, this.isOpen);
                this.$menuButtonOpenClass && this.$menuButton.classList.toggle(this.$menuButtonOpenClass, this.isOpen);
                this.$menuButton.setAttribute('aria-expanded', this.isOpen);
                if (this.$menuButtonCloseLabel && this.$menuButtonOpenLabel) {
                this.$menuButton.setAttribute('aria-label', (this.isOpen ? this.$menuButtonCloseLabel : this.$menuButtonOpenLabel));
                }
                if (this.$menuButtonCloseText && this.$menuButtonOpenText) {
                this.$menuButton.innerHTML = this.isOpen ? this.$menuButtonCloseText : this.$menuButtonOpenText;
                }
            }
            /**
            * Initialise header
            *
            * Check for the presence of the header, menu and menu button â€“ if any are
            * missing then there's nothing to do so return early.
            */
            if (!this.$header && !this.$numberOfNavs) {
                return
            }
            /**
            * The header can render with one or two navigation elements which collapse
            * into dropdowns on the mobile variation. This initialises the dropdown
            * functionality for all navs that have a menu button which has:
            * 1. a class of .js-x-header-toggle
            * 2. an aria-controls attribute which can be mapped to the ID of the element
            * that should be hidden on mobile
            */
            for (var i = 0; i < this.$numberOfNavs; i++) {
                var $nav = this.$navigation[i];
                $nav.$menuButton = $nav.querySelector('.js-x-header-toggle');
                $nav.$menu = $nav.$menuButton && $nav.querySelector(
                '#' + $nav.$menuButton.getAttribute('aria-controls')
                );
                $nav.menuItems = $nav.$menu && $nav.$menu.querySelectorAll('li');
                if (!$nav.$menuButton || !$nav.$menu || $nav.menuItems.length < 2) {
                return;
                }
                $nav.classList.add("toggle-enabled");
                $nav.$menuOpenClass = $nav.$menu && $nav.$menu.dataset.openClass;
                $nav.$menuButtonOpenClass = $nav.$menuButton && $nav.$menuButton.dataset.openClass;
                $nav.$menuButtonOpenLabel = $nav.$menuButton && $nav.$menuButton.dataset.labelForShow;
                $nav.$menuButtonCloseLabel = $nav.$menuButton && $nav.$menuButton.dataset.labelForHide;
                $nav.$menuButtonOpenText = $nav.$menuButton && $nav.$menuButton.dataset.textForShow;
                $nav.$menuButtonCloseText = $nav.$menuButton && $nav.$menuButton.dataset.textForHide;
                $nav.isOpen = false;
                $nav.$menuButton.addEventListener('click', this.handleMenuButtonClick.bind($nav));
            }
        }
        function initCrossServiceHeader () {
            const oneLoginHeader = document.querySelector("[data-module='one-login-header']");
            if (oneLoginHeader && CrossServiceHeader) {
                new CrossServiceHeader(oneLoginHeader);
            }
        }
        initCrossServiceHeader();
        export { CrossServiceHeader, initCrossServiceHeader };
    </script>
{% endblock %}

{% block footer %}
{{ govukFooter({
    "meta": {
        "items": [
            { "href": url_for("proto_manage.web.cookies_handler"), "text": _("Cookies") },
            { "href": url_for("proto_manage.web.accessibility_statement_handler"), "text": _("Accessibility statement") }
        ]
    }
}) }}
{% endblock footer %}
