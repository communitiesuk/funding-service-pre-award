{% from "govuk_frontend_jinja/components/back-link/macro.html" import govukBackLink %}
{% from "govuk_frontend_jinja/components/summary-list/macro.html" import govukSummaryList %}
{% from "govuk_frontend_jinja/components/error-summary/macro.html" import govukErrorSummary %}

{% extends "apply/base.jinja.html" %}

{% block pageTitle %}{% trans %}Monitoring and evaluation{% endtrans %} {{ report.code }} - {% trans %}Report funding progress{% endtrans %}{% endblock %}

{% block beforeContent %}
{{ super() }}
<div class="govuk-phase-banner">
    <div class="proto-phase govuk-!-padding-top-1 govuk-!-padding-bottom-1">
        <p class="govuk-phase-banner__content">
            {% set email %}<strong class="govuk-!-font-weight-bold">{{ account.email }}</strong>{% endset %}
            <span class="govuk-phase-banner__text">{% trans email=email %}You are reporting as {{ email }}{% endtrans %}</span>
        </p>
    </div>
</div>

{% if report.fake or (report.reporting_round and report.reporting_round.is_draft) %}
<style nonce="{{ csp_nonce() }}">
    {# reset a few nav things that don't play nicely with this #}
    .govuk-service-navigation__item, .govuk-service-navigation__service-name {
        border: 0;
    }
    .govuk-service-navigation__item--active {
        font-weight: bold;
    }
</style>
 <div class="test-data-banner govuk-body govuk-!-margin-bottom-2">
    <div class="test-data-tag">
        <strong>Preview report</strong>
    </div>
</div>
{% endif %}

{{ govukBackLink({
  "text": "Go back to report overview",
  "href": url_for("proto_report.tasklist", short_name=report.reporting_round.grant.short_name, reporting_round_id=report.reporting_round.id)
}) }}
{% endblock %}

{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    {% if form.errors %}
        {{ govukErrorSummary(wtforms_errors(form)) }}
    {% endif %}

    <span class="govuk-caption-l">{{ section.title }}</span>
    <h1 class="govuk-heading-l">
      {% if not report.is_submitted %}
        {% trans %}Check your answers{% endtrans %}
      {% else %}
        {% trans %}Your answers{% endtrans %}
      {% endif %}
    </h1>

    {% set rowData = [] %}
    {% for question in visible_questions %}
      {% set answer = get_answer_text_for_question_from_section_data(question, section_data) %}

      {% set valueHtml %}
        {% if answer %}
          <span>{{ answer }}</span>
        {% else %}
          <a class="govuk-link govuk-link--no-visited-state" href="{{ url_for('proto_report.ask_question', report_id=report.id, section_slug=section.slug, question_slug=question.slug, from_cya='True') }}">
            {# this should use the question "name" which I should add to record alongside it #}
            {# i.e project name - What is your project name? #}
            {% trans %}Enter answer{% endtrans %}
          </a>
        {% endif %}
      {% endset %}
      {% set __ = rowData.append(
          {
            "key": { "text": context_injector(question.title) },
            "value": { "html": valueHtml },
            "actions": {
              "items": [
                { "href": url_for('proto_report.ask_question', report_id=report.id, section_slug=section.slug, question_slug=question.slug, from_cya='True'), "text": "Change", "visuallyHiddenText": question.title, "classes": "govuk-link--no-visited-state" }
              ] if answer
            } if not report.is_submitted
          }
        ) %}
    {% endfor %}
    {{
      govukSummaryList({
        "rows": rowData
      })
    }}

    {% if not report.is_submitted %}
    <form method="post" novalidate>
      {{ form.csrf_token }}
      {{ form.complete(params={"classes": "govuk-radios--inline"}) }}
      {{ form.submit }}
    </form>
    {% endif %}
  </div>
</div>
{% endblock %}
